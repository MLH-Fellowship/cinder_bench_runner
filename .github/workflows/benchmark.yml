# Generated file: !!! DO NOT EDIT !!!
---
name: benchmark

on:
  workflow_dispatch:
    inputs:
      fork:
        description: Fork of cinder to benchmark
        default: facebookincubator
      ref:
        description: Branch, tag or (full) SHA commit to benchmark
        default: main
      base_version:
        description: Python version to use as the base
        type: string
        default: '3.11'
      machine:
        description: Machine to run on
        default: linux-amd64
        type: choice
        options:
        - linux-x64-ec2runner
        - all
      benchmarks:
        description: Benchmarks to run (comma-separated; empty runs all benchmarks)
        type: string
      benchmark_base:
        description: Also benchmark the base of this commit
        type: boolean
        default: false
      pystats:
        description: Also collect pystats for this commit
        type: boolean
        default: false

jobs:
  head:
    uses: ./.github/workflows/_benchmark_cinder.yml
    with:
      fork: ${{ inputs.fork }}
      ref: ${{ inputs.ref }}
      machine: ${{ inputs.machine }}
      benchmarks: ${{ inputs.benchmarks }}
      pgo: true
      perf: false
      force: true
    secrets: inherit

  base:
    uses: ./.github/workflows/_benchmark.yml
    with:
      fork: python
      ref: ${{ inputs.base_version }}
      machine: ${{ inputs.machine }}
      benchmarks: ${{ inputs.benchmarks }}
      pgo: true
      perf: false
      force: false
    secrets: inherit

  pystats-head:
    uses: ./.github/workflows/_pystats.yml
    if: ${{ inputs.pystats }}
    with:
      fork: ${{ inputs.fork }}
      ref: ${{ inputs.ref }}
      benchmarks: ${{ inputs.benchmarks }}
      force: true
    secrets: inherit

  pystats-base:
    uses: ./.github/workflows/_pystats.yml
    with:
      fork: python
      ref: ${{ inputs.base_version }}
      benchmarks: ${{ inputs.benchmarks }}
      force: false
    secrets: inherit

  generate:
    uses: ./.github/workflows/_generate.yml
    with:
      force: false
    if: ${{ always() }}
    needs: [head, base, pystats-head, pystats-base]
    secrets: inherit

  publish:
    uses: ./.github/workflows/_publish.yml
    if: ${{ always() }}
    needs: [generate]
    secrets: inherit
